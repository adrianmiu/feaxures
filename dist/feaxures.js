/*
 - MIT http://opensource.org/licenses/MIT
 @copyright - Adrian Miu www.adrianmiu.ro
*/
(function(r,p){"function"===typeof define&&define.amd?define("feaxures",function(){r.Feaxures=p();return r.Feaxures}):r.Feaxures=p()})(this,function(){var r=String.prototype,p=Array.prototype,w=Object.prototype,x=p.slice,t=p.forEach,e=window.jQuery,q=function(a,b,c){if(null!==a)if(t&&a.forEach===t)a.forEach(b,c);else if(a.length===+a.length)for(var d=0,h=a.length;d<h&&b.call(c,a[d],d,a)!=={};d++);else for(d in a)if(w.hasOwnProperty.call(a,d)&&b.call(c,a[d],d,a)==={})break},u=function(a){return r.trim?
r.trim.call(a):a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},y=function(a){(a=u(a))&&(window.execScript||function(a){window.eval.call(window,a)})(a)},z=Array.isArray||function(a){return"[object Array]"==toString.call(a)},s=function(a){q(x.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]});return a},v=function(a,b,c){a&&(a.nodeType&&b)&&(a[b]=c)},l;e&&e.Callbacks&&(l=function(){var a={},b=function(c){return a[c]||(a[c]=e.Callbacks("unique stopOnFalse"))};this.on=function(a,d){b(a).add(d);
return this};this.one=function(a,b){var h=this,g=function(){h.off(a,g);return b.apply(this,arguments)};this.on(a,g);return this};this.off=function(a,d){b(a).remove(d);return this};this.trigger=function(a){return b(a).fireWith(this,[].slice.call(arguments))}});var h={};h.loader=window.require;h.Deferred=e?e.Deferred:null;h.domReady=e?function(a){e(a)}:null;h.selector=e?function(a,b){return e(a,b)}:null;h.bindEvent=e?function(a,b,c){return e(a).on(b,c)}:null;h.unbindEvent=e?function(a,b,c){return e(a).off(b,
c)}:null;h.triggerEvent=e?function(a,b,c){return e(a).trigger(b,c)}:null;h.delegateEvent=e?function(a,b,c,d){return e(a).on(b,c,d)}:null;h.undelegateEvent=e?function(a,b,c,d){return e(a).off(b,c,d)}:null;h.EventsBehaviour=l;var h=s(h,window.FeaxuresDependencies||{}),A=function(a,b){var c=String(a).replace(/^&/,"").replace(/&$/,"").split("&"),d=c.length,h,g,f,e,l,k,m,n,p;b||(b=this.window);for(h=0;h<d;h++){g=c[h].split("=");f=decodeURIComponent(g[0].replace(/\+/g,"%20"));m=2>g.length?"":decodeURIComponent(g[1].replace(/\+/g,
"%20"));for("true"===m?m=!0:"false"===m?m=!1:m==parseInt(m,10)?m=parseInt(m,10):m==parseFloat(m)&&(m=parseFloat(m));" "===f.charAt(0);)f=f.slice(1);-1<f.indexOf("\x00")&&(f=f.slice(0,f.indexOf("\x00")));if(f&&"["!==f.charAt(0)){n=[];for(g=k=0;g<f.length;g++)if("["===f.charAt(g)&&!k)k=g+1;else if("]"===f.charAt(g)&&k&&(n.length||n.push(f.slice(0,k-1)),n.push(f.substr(k,g-k)),k=0,"["!==f.charAt(g+1)))break;n.length||(n=[f]);for(g=0;g<n[0].length;g++){k=n[0].charAt(g);if(" "===k||"."===k||"["===k)n[0]=
n[0].substr(0,g)+"_"+n[0].substr(g+1);if("["===k)break}k=b;g=0;for(p=n.length;g<p;g++)if(f=n[g].replace(/^['"]/,"").replace(/['"]$/,""),l=k,""!==f&&" "!==f||0===g)void 0===k[f]&&(k[f]={}),k=k[f];else{f=-1;for(e in k)k.hasOwnProperty(e)&&+e>f&&e.match(/^\d+$/g)&&(f=+e);f+=1}l[f]=m}}},p=function(a){this._loadedFeatures={};this._features={};this._config={};this.config(a);this.initialize();return this};l=p.prototype;h.EventsBehaviour.call(l);l.config=function(a){if("string"==typeof a){if(1===arguments.length)return this._config[a]||
!1;this._config[a]=arguments[1]}else{if(void 0===a)return this._config;this._config=s(this._config,a)}return this};l.log=function(){this.config("debug")&&"function"==typeof console.log&&console.log.apply(console,arguments)};l.isRegistered=function(a){return a&&this._features[a]?!0:!1};l.register=function(a,b){b=s({autoLoad:!1,selector:"[data-fxr-"+a+"]",files:[],defaults:{},attachEvent:"domready",attachCondition:!0,detach:null,onLoad:null,onLoadError:null,onAttach:null,onDetach:null},b,{name:a});
if("function"===typeof b.onLoad)this.on("load:"+a,b.onLoad);if("function"===typeof b.onLoadError)this.on("loadError:"+a,b.onLoadError);if("function"===typeof b.onAttach)this.on("attach:"+a,b.onAttach);if("function"===typeof b.onDetach)this.on("detach:"+a,b.onDetach);this._features[a]=b};l.isLoaded=function(a){return this._loadedFeatures[a]?!0:!1};l.load=function(a,b){var c=this,d=new h.Deferred;if(!this.isRegistered(a))return this.log("Feaxure "+a+" is not registered"),d.rejectWith(c,["Feaxure "+
a+" is not registered"]),d.promise();var e=this._features[a];"function"===typeof e.files&&(e.files=e.files.call(this));if(!z(e.files))return this.log('The feaxure "'+a+'" does not have a valid list of dependencies'),d.rejectWith(c,['The feaxure "'+a+'" does not have a valid list of dependencies']),d.promise();"function"===typeof b&&d.done(b);if(!0===this._loadedFeatures[a])return d.resolveWith(c),d.promise();if(!1===this._loadedFeatures[a])return d.rejectWith(c),d.promise();d.done(function(){if(!0!==
this._loadedFeatures[a]){this._loadedFeatures[a]=!0;c.log("Feaxure "+a+" was loaded");var b={feature:a};c.trigger("load",b);c.trigger("load:"+a,b)}});d.fail(function(b){!1!==this._loadedFeatures[a]&&(this._loadedFeatures[a]=!1,c.log("Error loading feaxure "+a),b={feature:a},c.trigger("loadError",b),c.trigger("loadError:"+a,b))});h.loader(e.files,function(){d.resolveWith(c,["Feaxure "+a+" was loaded"])},function(b){c.log("Error loading feaxure "+a,b);d.rejectWith(c,[b])});return d.promise()};l._detachFromElement=
function(a,b){var c=this;$(b);var d=this._features[a],e=!1;if(e="function"===typeof d.attachCondition&&"function"===typeof d.detach&&!1==d.attachCondition.call(d,b))d.detach.call(this,b),v(b,"fxr."+a,null),this.log("Feaxure "+a+" was applied to element",b),h.unbindEvent("body","dom:changed",function(){c._detachFromElement(a,b)}),d={feature:a,element:b},this.trigger("detach:"+a,d),this.trigger("detach",d)};l._attachToElement=function(a,b){var c=this,d=this._features[a],e="function"===typeof d.defaults?
d.defaults.call(c,b):d.defaults,g=b&&b.nodeType&&"data-fxr-"+a?b.getAttribute("data-fxr-"+a):null;if(null===(b&&b.nodeType&&"fxr."+a?b["fxr."+a]||null:null)||void 0===(b&&b.nodeType&&"fxr."+a?b["fxr."+a]||null:null)){var g="function"===typeof d.attachCondition?d.attachCondition.call(d,b):d.attachCondition,f="function"===typeof d.attachCondition&&"function"===typeof d.detach;g&&(g=this.getFeatureOptionsForElement(a,b),!1!==g&&(g=s({},e,g),d.attach.call(this,b,g),v(b,"fxr."+a,g),this.log("Feaxure "+
a+" was applied to element",b),f&&h.bindEvent("body","dom:changed",function(){c._detachFromElement(a,b)}),d={feature:a,element:b,options:g},this.trigger("attach:"+a,d),this.trigger("attach",d)))}};l.attach=function(a,b){var c=this,d=this._features[a],e=0,g=this.load(a),f=new h.Deferred;if(!d.attach||"function"!==typeof d.attach)return f.fail(function(a){c.log(a)}),f.rejectWith(c,['Feaxure "'+a+'" does not have an attach() method.']),f.promise();if(!b.length||1>b.length)return f.done(function(a){c.log(a)}),
f.resolve('Feaxure "'+a+'" has no elements to be applied to.'),f.promise();q(b,function(b,d){!1!==c.getFeatureOptionsForElement(a,b)&&e++});if(0===e)return f.done(function(a){c.log(a)}),f.resolveWith(c,['Feaxure "'+a+'" has no elements to be applied to.']),f.promise();g.done(function(){q(b,function(b,d){c._attachToElement(a,b)});f.resolveWith(c,[{feaxureName:a}])});return f.promise()};l.getFeatureOptionsForElement=function(a,b){var c=b&&b.nodeType&&"data-fxr-"+a?b.getAttribute("data-fxr-"+a):null;
if("false"===c)return!1;if("true"===c||""===c||null===c)return{};"#"==c.substr(0,1)&&(c=h.selector(c).text());c=u(c);if("{"==c.substr(0,1))eval("o = "+c+";"),c={};else if("function"==c.substr(0,8)){var d="_tmpFunc"+Math.floor(1E6*Math.random());y("var "+d+" = "+c);if("function"!==typeof window[d])return self.log("value could not be converted into a function: "+c),!1;c=window[d].call(null,b);window[d]=void 0;delete window[d]}else d={},A(c,d),c=d;return c};l.discover=function(a){var b=this,c=0,d=0,
e=new h.Deferred;"string"===typeof a&&(a=h.selector(a));q(this._features,function(a,b){"domready"===a.attachEvent&&c++});q(this._features,function(g,f){"domready"===g.attachEvent&&b.attach(f,h.selector(g.selector,a)).always(function(){d++;d===c&&e.resolveWith(b,[{feaxuresAttached:d}])})});return e.promise()};l.initialize=function(){var a=this;q(this._features,function(b,c){!0!==c.autoLoad||a._loadedFeatures[c.name]||a.load(c.name)});h.domReady(function(){a.discover("body");h.bindEvent("body","dom:changed",
function(){a.discover("body")});h.bindEvent(window,"resize",function(){h.triggerEvent("body","dom:changed")});var b=["click","focus","mouseover"];q(a._features,function(c,d){if(-1!==b.indexOf(c.attachEvent)){var e=c.attachEvent,g=function(b,l){if(!1===a.getFeatureOptionsForElement(d,b.target))return!1;b.stopPropagation();b.preventDefault();a.load(d).done(function(){h.undelegateEvent("body",e+".feaxures",c.selector,g);a.attach(d,h.selector(c.selector));a._features[d].attachEvent="domReady";h.triggerEvent(b.target,
e)})};h.delegateEvent("body",e+".feaxures",c.selector,g)}})});return this};return p});