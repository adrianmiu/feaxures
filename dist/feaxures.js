/*
 - MIT http://opensource.org/licenses/MIT
 @copyright - Adrian Miu www.adrianmiu.ro
*/
(function(r,n){"function"===typeof define&&define.amd?define("feaxures",function(){r.Feaxures=n();return r.Feaxures}):r.Feaxures=n()})(this,function(){var r=String.prototype,n=Array.prototype,v=Object.prototype,w=n.slice,t=n.forEach,e=window.jQuery,q=function(a,b,c){if(null!=a)if(t&&a.forEach===t)a.forEach(b,c);else if(a.length===+a.length)for(var d=0,f=a.length;d<f&&b.call(c,a[d],d,a)!=={};d++);else for(d in a)if(v.hasOwnProperty.call(a,d)&&b.call(c,a[d],d,a)==={})break},u=function(a){return r.trim?
r.trim.call(a):a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},x=function(a){(a=u(a))&&(window.execScript||function(a){window.eval.call(window,a)})(a)},y=Array.isArray||function(a){return"[object Array]"==toString.call(a)},s=function(a){q(w.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]});return a},l;e&&e.Callbacks&&(l=function(){var a={},b=function(c){return a[c]||(a[c]=e.Callbacks("unique stopOnFalse"))};this.on=function(a,d){b(a).add(d);return this};this.one=function(a,b){var f=this,
g=function(){f.off(a,g);return b.apply(this,arguments)};this.on(a,g);return this};this.off=function(a,d){b(a).remove(d);return this};this.trigger=function(a){return b(a).fireWith(this,[].slice.call(arguments))}});var f={};f.loader=window.require;f.Deferred=e?e.Deferred:null;f.domReady=e?function(a){e(a)}:null;f.selector=e?function(a,b){return e(a,b)}:null;f.getAttr=e?function(a,b){return e(a).attr(b)}:null;f.getData=e?function(a,b){return e.data(a,b)}:null;f.setData=e?function(a,b,c){return e.data(a,
b,c)}:null;f.bindEvent=e?function(a,b,c){return e(a).on(b,c)}:null;f.unbindEvent=e?function(a,b,c){return e(a).off(b,c)}:null;f.triggerEvent=e?function(a,b,c){return e(a).trigger(b,c)}:null;f.delegateEvent=e?function(a,b,c,d){return e(a).on(b,c,d)}:null;f.undelegateEvent=e?function(a,b,c,d){return e(a).off(b,c,d)}:null;f.EventsBehaviour=l;var f=s(f,window.FeaxuresDependencies||{}),z=function(a,b){var c=String(a).replace(/^&/,"").replace(/&$/,"").split("&"),d=c.length,f,g,h,e,l,k,m,p,n;b||(b=this.window);
for(f=0;f<d;f++){g=c[f].split("=");h=decodeURIComponent(g[0].replace(/\+/g,"%20"));m=2>g.length?"":decodeURIComponent(g[1].replace(/\+/g,"%20"));for("true"===m?m=!0:"false"===m?m=!1:m==parseInt(m,10)?m=parseInt(m,10):m==parseFloat(m)&&(m=parseFloat(m));" "===h.charAt(0);)h=h.slice(1);-1<h.indexOf("\x00")&&(h=h.slice(0,h.indexOf("\x00")));if(h&&"["!==h.charAt(0)){p=[];for(g=k=0;g<h.length;g++)if("["===h.charAt(g)&&!k)k=g+1;else if("]"===h.charAt(g)&&k&&(p.length||p.push(h.slice(0,k-1)),p.push(h.substr(k,
g-k)),k=0,"["!==h.charAt(g+1)))break;p.length||(p=[h]);for(g=0;g<p[0].length;g++){k=p[0].charAt(g);if(" "===k||"."===k||"["===k)p[0]=p[0].substr(0,g)+"_"+p[0].substr(g+1);if("["===k)break}k=b;g=0;for(n=p.length;g<n;g++)if(h=p[g].replace(/^['"]/,"").replace(/['"]$/,""),l=k,""!==h&&" "!==h||0===g)void 0===k[h]&&(k[h]={}),k=k[h];else{h=-1;for(e in k)k.hasOwnProperty(e)&&+e>h&&e.match(/^\d+$/g)&&(h=+e);h+=1}l[h]=m}}},n=function(a){this._loadedFeatures={};this._features={};this._config={};this.config(a);
this.initialize();return this};l=n.prototype;f.EventsBehaviour.call(l);l.config=function(a){if("string"==typeof a){if(1===arguments.length)return this._config[a]||!1;this._config[a]=arguments[1]}else{if(void 0===a)return this._config;this._config=s(this._config,a)}return this};l.log=function(){this.config("debug")&&"function"==typeof console.log&&console.log.apply(console,arguments)};l.isRegistered=function(a){return a&&this._features[a]?!0:!1};l.register=function(a,b){b=s({autoLoad:!1,selector:"[data-fxr-"+
a+"]",files:[],defaults:{},attachEvent:"domready",attachCondition:!0,detach:null,onLoad:null,onLoadError:null,onAttach:null,onDetach:null},b,{name:a});if("function"===typeof b.onLoad)this.on("load:"+a,b.onLoad);if("function"===typeof b.onLoadError)this.on("loadError:"+a,b.onLoadError);if("function"===typeof b.onAttach)this.on("attach:"+a,b.onAttach);if("function"===typeof b.onDetach)this.on("detach:"+a,b.onDetach);this._features[a]=b};l.isLoaded=function(a){return this._loadedFeatures[a]?!0:!1};l.load=
function(a,b){var c=this,d=new f.Deferred;if(!this.isRegistered(a))return this.log("Feaxure "+a+" is not registered"),d.rejectWith(c,["Feaxure "+a+" is not registered"]),d.promise();var e=this._features[a];"function"===typeof e.files&&(e.files=e.files.call(this));if(!y(e.files))return this.log('The feaxure "'+a+'" does not have a valid list of dependencies'),d.rejectWith(c,['The feaxure "'+a+'" does not have a valid list of dependencies']),d.promise();"function"===typeof b&&d.done(b);if(!0===this._loadedFeatures[a])return d.resolveWith(c),
d.promise();if(!1===this._loadedFeatures[a])return d.rejectWith(c),d.promise();d.done(function(){if(!0!==this._loadedFeatures[a]){this._loadedFeatures[a]=!0;c.log("Feaxure "+a+" was loaded");var b={feature:a};c.trigger("load",b);c.trigger("load:"+a,b)}});d.fail(function(b){!1!==this._loadedFeatures[a]&&(this._loadedFeatures[a]=!1,c.log("Error loading feaxure "+a),b={feature:a},c.trigger("loadError",b),c.trigger("loadError:"+a,b))});f.loader(e.files,function(){d.resolveWith(c,["Feaxure "+a+" was loaded"])},
function(b){c.log("Error loading feaxure "+a,b);d.rejectWith(c,[b])});return d.promise()};l._detachFromElement=function(a,b){var c=this;$(b);var d=this._features[a],e=!1;if(e="function"===typeof d.attachCondition&&"function"===typeof d.detach&&!1==d.attachCondition.call(d,b))d.detach.call(this,b),f.setData(b,"fxr."+a,null),this.log("Feaxure "+a+" was applied to element",b),f.unbindEvent("body","dom:changed",function(){c._detachFromElement(a,b)}),d={feature:a,element:b},this.trigger("detach:"+a,d),
this.trigger("detach",d)};l._attachToElement=function(a,b){var c=this,d=this._features[a],e="function"===typeof d.defaults?d.defaults.call(c,b):d.defaults,g=f.getAttr(b,"data-fxr-"+a);if(null===f.getData(b,"fxr."+a)||void 0===f.getData(b,"fxr."+a)){var g="function"===typeof d.attachCondition?d.attachCondition.call(d,b):d.attachCondition,h="function"===typeof d.attachCondition&&"function"===typeof d.detach;g&&(g=this.getFeatureOptionsForElement(a,b),!1!==g&&(g=s({},e,g),d.attach.call(this,b,g),f.setData(b,
"fxr."+a,g),this.log("Feaxure "+a+" was applied to element",b),h&&f.bindEvent("body","dom:changed",function(){c._detachFromElement(a,b)}),d={feature:a,element:b,options:g},this.trigger("attach:"+a,d),this.trigger("attach",d)))}};l.attach=function(a,b){var c=this,d=this._features[a],e=0,g=this.load(a),h=new f.Deferred;if(!d.attach||"function"!==typeof d.attach)return h.fail(function(a){c.log(a)}),h.rejectWith(c,['Feaxure "'+a+'" does not have an attach() method.']),h.promise();if(!b.length||1>b.length)return h.done(function(a){c.log(a)}),
h.resolve('Feaxure "'+a+'" has no elements to be applied to.'),h.promise();q(b,function(b,d){!1!==c.getFeatureOptionsForElement(a,b)&&e++});if(0===e)return h.done(function(a){c.log(a)}),h.resolveWith(c,['Feaxure "'+a+'" has no elements to be applied to.']),h.promise();g.done(function(){q(b,function(b,d){c._attachToElement(a,b)});h.resolveWith(c,[{feaxureName:a}])});return h.promise()};l.getFeatureOptionsForElement=function(a,b){var c=f.getAttr(b,"data-fxr-"+a);if("false"===c)return!1;if("true"===
c||""===c)return{};"#"==c.substr(0,1)&&(c=f.selector(c).text());c=u(c);if("{"==c.substr(0,1))eval("o = "+c+";"),c={};else if("function"==c.substr(0,8)){var d="_tmpFunc"+Math.floor(1E6*Math.random());x("var "+d+" = "+c);if("function"!==typeof window[d])return self.log("value could not be converted into a function: "+c),!1;c=window[d].call(null,b);window[d]=void 0;delete window[d]}else d={},z(c,d),c=d;return c};l.discover=function(a){var b=this,c=0,d=0,e=new f.Deferred;"string"===typeof a&&(a=f.selector(a));
q(this._features,function(a,b){"domready"===a.attachEvent&&c++});q(this._features,function(g,h){"domready"===g.attachEvent&&b.attach(h,f.selector(g.selector,a)).always(function(){d++;d===c&&e.resolveWith(b,[{feaxuresAttached:d}])})});return e.promise()};l.initialize=function(){var a=this;q(this._features,function(b,c){!0!==c.autoLoad||a._loadedFeatures[c.name]||a.load(c.name)});f.domReady(function(){a.discover("body");f.bindEvent("body","dom:changed",function(){a.discover("body")});f.bindEvent(window,
"resize",function(){f.triggerEvent("body","dom:changed")});var b=["click","focus","mouseover"],c;q(a._features,function(d,e){if(-1!==b.indexOf(d.attachEvent)){var g=d.attachEvent;c=function(b,l){if(!1!==a.getFeatureOptionsForElement(e,b.target)){b.stopPropagation();b.preventDefault();var n=f.selector(d.selector);a.attach(e,[b.target]);a.one("attach:"+e,function(k){f.undelegateEvent("body",g+".feaxures",d.selector,c);f.triggerEvent(b.target,g);a.attach(e,n)})}};f.delegateEvent("body",g+".feaxures",
d.selector,c)}})});return this};return n});