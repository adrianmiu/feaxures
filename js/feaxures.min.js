/**
 * Feaxures JS - progressive enhancement, done right!
 * @license - MIT http://opensource.org/licenses/MIT
 * @copyright - Adrian Miu www.adrianmiu.ro
 */
(function(a,b){"function"==typeof define&&define.amd?define(["jquery"],function(c){return a.Feaxures=b(c)}):a.Feaxures=b(a.jQuery)})(this,function(jQuery){var parse_str=function(a,b){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,c=(a+"").replace(/^&/,"").replace(/&$/,"").split("&"),d=c.length,t=function(a){return decodeURIComponent(a.replace(/\+/g,"%20"))};for(b||(b=this.window),e=0;d>e;e++){for(n=c[e].split("="),o=t(n[0]),p=2>n.length?"":t(n[1]),"true"===p?p=!0:"false"===p?p=!1:p==parseInt(p,10)?p=parseInt(p,10):p==parseFloat(p)&&(p=parseFloat(p));" "===o.charAt(0);)o=o.slice(1);if(o.indexOf("\0")>-1&&(o=o.slice(0,o.indexOf("\0"))),o&&"["!==o.charAt(0)){for(r=[],q=0,f=0;o.length>f;f++)if("["!==o.charAt(f)||q){if("]"===o.charAt(f)&&q&&(r.length||r.push(o.slice(0,q-1)),r.push(o.substr(q,f-q)),q=0,"["!==o.charAt(f+1)))break}else q=f+1;for(r.length||(r=[o]),f=0;r[0].length>f&&(m=r[0].charAt(f),(" "===m||"."===m||"["===m)&&(r[0]=r[0].substr(0,f)+"_"+r[0].substr(f+1)),"["!==m);f++);for(j=b,f=0,s=r.length;s>f;f++)if(o=r[f].replace(/^['"]/,"").replace(/['"]$/,""),k=f!==r.length-1,i=j,""!==o&&" "!==o||0===f)j[o]===l&&(j[o]={}),j=j[o];else{g=-1;for(h in j)j.hasOwnProperty(h)&&+h>g&&h.match(/^\d+$/g)&&(g=+h);o=g+1}i[o]=p}}},_config={},_loadedFeatures={},_features={},_events,_each=jQuery.each,_load=require,Feaxures=function(a){return this.config(a),_events=$(this),this};return Feaxures.prototype.on=function(a,b){return _events.on(a,b),this},Feaxures.prototype.one=function(a,b){return _events.one(a,b),this},Feaxures.prototype.off=function(a,b){return _events.off(a,b),this},Feaxures.prototype.trigger=function(){this.log('Event "'+arguments[0].type+'" was called'),_events.trigger.apply(_events,arguments)},Feaxures.prototype.config=function(a){if($.isPlainObject(a))_config=$.extend(_config,a);else if("string"==typeof a){if(1===arguments.length)return _config[a]||!1;_config[a]=arguments[1]}else if(void 0===a)return _config;return this},Feaxures.prototype.log=function(){this.config("debug")&&"function"==typeof console.log&&console.log.apply(console,arguments)},Feaxures.prototype.isRegistered=function(a){return a&&_features[a]?!0:!1},Feaxures.prototype.register=function(a,b){b=$.extend({autoLoad:!1,selector:"[data-fxr-"+a+"]",files:[],defaults:{},attachEvent:"domready",onLoad:null,onLoadError:null,onBeforeAttach:null,onAfterAttach:null},b,{name:a}),"function"==typeof b.onLoad&&this.on("load:"+a,b.onLoad),"function"==typeof b.onLoadError&&this.on("loadError:"+a,b.onLoadError),"function"==typeof b.onBeforeAttach&&this.on("beforeAttach:"+a,b.onBeforeAttach),"function"==typeof b.onAfterAttach&&this.on("afterAttach:"+a,b.onAfterAttach),_features[a]=b},Feaxures.prototype.isLoaded=function(a){return _loadedFeatures[a]?!0:!1},Feaxures.prototype.load=function(a,b){var c=this,d=$.Deferred();if(!this.isRegistered(a))return this.log("Feature "+a+" is not registered"),d.rejectWith(c,["Feature "+a+" is not registered"]),d.promise();var e=_features[a];return"function"==typeof e.files&&(e.files=e.files.call(this)),jQuery.isArray(e.files)?("function"==typeof b&&d.done(b),_loadedFeatures[a]===!0?(d.resolveWith(c),d.promise()):_loadedFeatures[a]===!1?(d.rejectWith(c),d.promise()):(d.done(function(){if(_loadedFeatures[a]!==!0){_loadedFeatures[a]=!0,c.log("Feature "+a+" was loaded");var b=jQuery.Event("load");b.feature=a,c.trigger(b),b=jQuery.Event("load:"+a),b.feature=a,c.trigger(b)}}),d.fail(function(){if(_loadedFeatures[a]!==!1){_loadedFeatures[a]=!1,c.log("Error loading feature "+a);var d=jQuery.Event("loadError");d.feature=a,c.trigger(d),d=jQuery.Event("loadError:"+a),d.feature=a,c.trigger(d)}}),_load(e.files,function(){d.resolveWith(c,["feature "+a+" was loaded"])},function(b){c.log("error loading feature "+a,b),d.rejectWith(c,[b])}),d.promise())):(this.log('The feature "'+a+'" does not have a valid list of dependencies'),d.rejectWith(c,["not valid"]),d.promise())},Feaxures.prototype.attach=function(a,b){var c=this,d=_features[a],e=0,f=this.load(a),g=$.Deferred();return d.attach&&"function"==typeof d.attach?!b.length||1>b.length?(g.done(function(a){c.log(a)}),g.resolve('Feaxure "'+a+'" has no elements to be applied to.'),g.promise()):(_each(b,function(){$(this),options=c.getFeatureOptionsForElement(a,this),options!==!1&&e++}),0===e?(g.done(function(a){c.log(a)}),g.resolveWith(c,['Feaxure "'+a+'" has no elements to be applied to.']),g.promise()):(f.done(function(){_each(b,function(b,e){var f=$(this),g="function"==typeof d.defaults?d.defaults.call(c,e):d.defaults;if(options=f.attr("data-fxr-"+a),alreadyAttached=null!==f.data("fxr."+a)&&void 0!==f.data("fxr."+a),!alreadyAttached){if(options=c.getFeatureOptionsForElement(a,this),options!==!1){options=$.extend({},g,options);var h=jQuery.Event("beforeAttach");if(h.target=e,h.feature=a,h.options=options,c.trigger(h),h.result===!1||h.isDefaultPrevented())return f.attr("data-fxr-"+a,null),f.data("fxr."+a,!1),c.log("Feature "+a+" was not applied because the global before attach events prevents it"),void 0;if(h=jQuery.Event("beforeAttach:"+a),h.target=e,h.feature=a,h.options=options,c.trigger(h),h.result===!1||h.isDefaultPrevented())return f.attr("data-fxr-"+a,null),f.data("fxr."+a,!1),c.log("Feature "+a+" was not applied because the feature's before attach prevents it"),void 0;d.attach.call(c,e,options),c.log("Feature "+a+" was applied to element",e),h=jQuery.Event("afterAttach:"+a),h.target=e,h.feature=a,h.options=options,c.trigger(h),h=jQuery.Event("afterAttach"),h.target=e,h.feature=a,h.options=options,c.trigger(h)}f.attr("data-fxr-"+a,null),f.data("fxr."+a,options)}}),g.resolveWith(c,[{feaxureName:a}])}),g.promise())):(g.fail(function(a){c.log(a)}),g.rejectWith(c,['Feaxure "'+a+'" does not have an attach() method.']),g.promise())},Feaxures.prototype.getFeatureOptionsForElement=function(feature,domElement){var options=$(domElement).attr("data-fxr-"+feature);if("false"===options)return!1;if("true"===options||""===options)return{};if("#"==options.substr(0,1)&&(options=$(options).text()),options=jQuery.trim(options),"{"==options.substr(0,1)){var o={};eval("o = "+options+";"),options=o}else if("function"==options.substr(0,8)){var funcName="_tmpFunc"+Math.floor(1e6*Math.random());if($.globalEval("var "+funcName+" = "+options),"function"!=typeof window[funcName])return self.log("value could not be converted into a function: "+options),!1;options=window[funcName].call(null,domElement),window[funcName]=void 0,delete window[funcName]}else{var arr={};parse_str(options,arr),options=arr}return options},Feaxures.prototype.discover=function(a){var b=this,c=0,d=0,e=$.Deferred();return"string"==typeof a&&(a=$(a)),_each(_features,function(a,b){"domready"===b.attachEvent&&c++}),_each(_features,function(f,g){"domready"===g.attachEvent&&b.attach(f,$(g.selector,a)).always(function(){d++,d===c&&e.resolveWith(b,[{feaxuresAttached:d}])})}),e.promise()},Feaxures.prototype.initialize=function(){var a=this;return _each(_features,function(b,c){c.autoLoad!==!0||_loadedFeatures[c.name]||a.load(c.name)}),jQuery(function(){a.discover("body"),jQuery("body").on("dom:changed",function(){a.discover("body")}),_each(_features,function(b,c){_each(["click","focus","mouseover"],function(d,e){e===c.attachEvent&&$("body").on(e+".feaxures",c.selector,function(d){if(a.getFeatureOptionsForElement(b,d.currentTarget)!==!1){d.stopPropagation(),d.preventDefault();var g=$(c.selector).not($(d.currentTarget));a.attach(b,$(d.currentTarget)),a.one("afterAttach:"+b,function(){$("body").off(e+".feaxures",c.selector,d.handler),$(d.target).trigger(e),a.attach(b,g)})}})})})}),this},Feaxures});